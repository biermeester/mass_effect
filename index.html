<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Front Camera Preview</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b0c10;
      color: #edf5e1;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 1rem;
    }

    main {
      display: grid;
      gap: 1rem;
      width: min(90vw, 32rem);
      text-align: center;
    }

    video,
    #capturePreview {
      width: 100%;
      border-radius: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.35);
      background: #1f2833;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      transform: scaleX(-1);
    }

    #capturePreview {
      transform: none;
    }

    .actions {
      display: grid;
      gap: 0.5rem;
    }

    button,
    .link-button {
      appearance: none;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 999px;
      background: #45a29e;
      color: #0b0c10;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    button:disabled,
    .link-button[aria-disabled="true"] {
      display: none;
    }

    .status {
      font-size: 0.95rem;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <main>
    <video id="preview" autoplay playsinline muted></video>
    <img id="capturePreview" alt="Captured photo" hidden />
    <p class="status" id="status">Tap the button below to grant camera access.</p>
    <div class="actions">
      <button id="start">ðŸŽ¥ Enable Camera</button>
      <button id="capture" disabled hidden>ðŸ“¸ Capture Photo</button>
      <button id="share" disabled hidden>ðŸ“¤ Share Photo</button>
      <a id="download" class="link-button" hidden aria-disabled="true">ðŸ’¾ Download Photo</a>
      <button id="setCounter">Ich hab's verkackt!</button>
    </div>
  </main>

  <script>
    const startButton = document.getElementById('start');
    const status = document.getElementById('status');
    const preview = document.getElementById('preview');
    const capturePreview = document.getElementById('capturePreview');
    const captureButton = document.getElementById('capture');
    const shareButton = document.getElementById('share');
    const downloadLink = document.getElementById('download');
    const setCounterButton = document.getElementById('setCounter');

    let lastCaptureBlob = null;
    let lastCaptureFile = null;
    let lastCaptureFileName = '';
    let lastCaptureURL = null;
    const captureCanvas = document.createElement('canvas');

    const PROST_COOKIE = 'prostCounter';
    const COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1 year.

    function readProstCounter() {
      const cookies = document.cookie ? document.cookie.split('; ') : [];
      for (const entry of cookies) {
        const [name, value] = entry.split('=');
        if (name === PROST_COOKIE) {
          const numeric = Number.parseInt(value, 10);
          if (Number.isFinite(numeric) && numeric > 0) {
            return numeric;
          }
        }
      }
      return null;
    }

    function writeProstCounter(value) {
      const safeValue = Math.max(1, Math.floor(value));
      document.cookie = `${PROST_COOKIE}=${safeValue}; max-age=${COOKIE_MAX_AGE}; path=/; SameSite=Lax`;
      return safeValue;
    }

    let prostCounter = readProstCounter();
    if (!prostCounter) {
      prostCounter = writeProstCounter(1);
    }

    function bumpProstCounter() {
      prostCounter = writeProstCounter(prostCounter + 1);
      return prostCounter;
    }

    function setProstCounterManually() {
      const input = window.prompt('How many MaÃŸ did you already drink this Oktoberfest?', String(prostCounter));
      if (input === null) {
        return;
      }

      const nextValue = Number.parseInt(input.trim(), 10);
      if (!Number.isFinite(nextValue) || nextValue < 1) {
        window.alert('Please enter a whole number greater than or equal to 1.');
        return;
      }

      prostCounter = writeProstCounter(nextValue);
      status.textContent = `Counter updated. Next capture will be Prost #${prostCounter}.`;
    }

    const hasNavigatorShare = typeof navigator.share === 'function';
    const supportsShareFiles = hasNavigatorShare
      && typeof navigator.canShare === 'function'
      && typeof File === 'function';

    if (!hasNavigatorShare) {
      shareButton.disabled = true;
      shareButton.hidden = true;
      shareButton.title = 'Sharing images requires a compatible browser.';
    } else if (!supportsShareFiles) {
      shareButton.title = 'Your browser may limit photo sharing; we will still try.';
    }

    async function enableCamera() {
      startButton.disabled = true;
      status.textContent = 'Requesting camera access...';

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'user' } },
          audio: false,
        });

        preview.srcObject = stream;
        preview.addEventListener('loadeddata', onPreviewReady, { once: true });
        status.textContent = 'Camera stream active.';
        startButton.textContent = 'âœ… Camera Enabled';
      } catch (error) {
        console.error('getUserMedia failed', error);
        status.textContent = 'Unable to access the camera. Please check browser permissions and try again.';
        startButton.disabled = false;
      }
    }

    function onPreviewReady() {
      captureButton.disabled = false;
      captureButton.hidden = false;
      status.textContent = 'Camera ready. Capture a photo when you like.';
    }

    function resetCaptureState() {
      lastCaptureBlob = null;
      lastCaptureFile = null;
      lastCaptureFileName = '';
      if (lastCaptureURL) {
        URL.revokeObjectURL(lastCaptureURL);
        lastCaptureURL = null;
      }
      shareButton.disabled = true;
      shareButton.hidden = true;
      downloadLink.hidden = true;
      downloadLink.setAttribute('aria-disabled', 'true');
      capturePreview.hidden = true;
      capturePreview.removeAttribute('src');
      preview.hidden = false;
    }

    async function captureFrame() {
      if (!preview.srcObject) {
        status.textContent = 'Camera is not active.';
        return;
      }

      if (preview.readyState < HTMLMediaElement.HAVE_CURRENT_DATA) {
        status.textContent = 'Hold onâ€”video is still loading.';
        return;
      }

      captureButton.disabled = true;
      status.textContent = 'Capturing photo...';

      resetCaptureState();

      const width = preview.videoWidth;
      const height = preview.videoHeight;

      if (!width || !height) {
        status.textContent = 'Unable to capture right now. Please try again.';
        captureButton.disabled = false;
        return;
      }

      captureCanvas.width = width;
      captureCanvas.height = height;

      const ctx = captureCanvas.getContext('2d');
      if (!ctx) {
        status.textContent = 'Unable to capture right now. Please try again.';
        captureButton.disabled = false;
        return;
      }
      ctx.save();
      ctx.translate(width, 0);
      ctx.scale(-1, 1); // Mirror to match on-screen preview.
      ctx.drawImage(preview, 0, 0, width, height);
      ctx.restore();

      const overlayText = `Prost #${prostCounter}`;
      const fontSize = Math.round(Math.min(width, height) * 0.08);
      const margin = Math.max(fontSize * 0.3, 16);
      const textX = width / 2;
      const textY = height - margin;

      ctx.font = `700 ${fontSize}px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.lineJoin = 'round';
      ctx.lineWidth = Math.max(fontSize * 0.12, 4);
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.85)';
      ctx.fillStyle = '#ffffff';
      ctx.strokeText(overlayText, textX, textY);
      ctx.fillText(overlayText, textX, textY);

      captureCanvas.toBlob((blob) => {
        captureButton.disabled = false;

        if (!blob) {
          status.textContent = 'Capture failed. Please try again.';
          return;
        }

        lastCaptureBlob = blob;
        lastCaptureFileName = `front-camera-${Date.now()}.jpg`;
        lastCaptureFile = new File([blob], lastCaptureFileName, { type: blob.type });
        lastCaptureURL = URL.createObjectURL(blob);
        capturePreview.src = lastCaptureURL;
        capturePreview.hidden = false;
        preview.hidden = true;
        downloadLink.href = lastCaptureURL;
        downloadLink.download = lastCaptureFileName;
        downloadLink.hidden = false;
        downloadLink.setAttribute('aria-disabled', 'false');

        let shareState = 'unavailable';

        if (hasNavigatorShare) {
          let canSharePhoto = true;

          if (supportsShareFiles) {
            try {
              canSharePhoto = navigator.canShare({ files: [lastCaptureFile] });
            } catch (error) {
              canSharePhoto = false;
            }
          }

          shareButton.disabled = false;
          shareButton.hidden = false;
          shareButton.title = canSharePhoto
            ? 'Share via apps like Signal or WhatsApp.'
            : 'Your browser might not support photo sharing, but you can try.';
          shareState = canSharePhoto ? 'available' : 'limited';
        } else {
          shareButton.disabled = true;
          shareButton.hidden = true;
        }

        status.textContent = shareState === 'available'
          ? 'Photo ready. Share or download below.'
          : shareState === 'limited'
            ? 'Photo ready. Sharing might not work in this browserâ€”download or try sharing below.'
            : 'Photo ready. Share is unavailable on this deviceâ€”download below.';
      }, 'image/jpeg', 0.95);
    }

    async function shareCapture() {
      if (!lastCaptureBlob) {
        status.textContent = 'Capture a photo before sharing.';
        return;
      }

      if (!hasNavigatorShare || !lastCaptureFile) {
        status.textContent = 'Sharing is not supported on this device. Use the download option instead.';
        shareButton.disabled = true;
        shareButton.hidden = true;
        return;
      }

      if (supportsShareFiles) {
        let canSharePhoto = false;

        try {
          canSharePhoto = navigator.canShare({ files: [lastCaptureFile] });
        } catch (error) {
          canSharePhoto = false;
        }

        if (!canSharePhoto) {
          status.textContent = 'This browser cannot share photos. Use the download option instead.';
          shareButton.title = 'Download the photo, then share it manually.';
          return;
        }
      }

      const sharePayload = { files: [lastCaptureFile], title: 'Front camera photo' };

      try {
        await navigator.share(sharePayload);
        const updatedCounter = bumpProstCounter();
        status.textContent = `Shared! Next photo will be Prost #${updatedCounter}.`;
      } catch (error) {
        if (error.name === 'AbortError') {
          return;
        }

        console.error('Share failed', error);

        if (!supportsShareFiles && error.name === 'TypeError') {
          status.textContent = 'This browser does not support sharing photos. Use download instead.';
          shareButton.title = 'Download the photo, then share it manually.';
          return;
        }

        status.textContent = 'Sharing failed. You can still download the photo.';
      }
    }

    if (!navigator.mediaDevices?.getUserMedia) {
      status.textContent = 'Camera access is not supported in this browser.';
      startButton.disabled = true;
      captureButton.disabled = true;
    } else {
      startButton.addEventListener('click', enableCamera);
      captureButton.addEventListener('click', captureFrame);
      shareButton.addEventListener('click', shareCapture);
      setCounterButton.addEventListener('click', setProstCounterManually);

      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({ name: 'camera' }).then((result) => {
          if (result.state === 'granted') {
            enableCamera();
          }
        }).catch(() => { });
      }
    }
  </script>
</body>

</html>
