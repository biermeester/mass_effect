<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Front Camera Preview</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b0c10;
      color: #edf5e1;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: calc(env(safe-area-inset-top, 0) + 0.25rem) 0.75rem 1.5rem;
      gap: 0.75rem;
    }

    main {
      display: grid;
      gap: 0.75rem;
      width: min(92vw, 30rem);
      text-align: center;
    }

    video,
    #capturePreview {
      width: 100%;
      border-radius: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.35);
      background: #1f2833;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      transform: scaleX(-1);
    }

    #capturePreview {
      transform: none;
    }

    .actions {
      display: grid;
      gap: 0.5rem;
    }

    button,
    .link-button {
      appearance: none;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 999px;
      background: #45a29e;
      color: #0b0c10;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 1rem;
    }

    button:disabled,
    .link-button[aria-disabled="true"] {
      display: none;
    }

    .status {
      font-size: 0.95rem;
      line-height: 1.25;
      margin: 0.25rem 0;
    }

    #countdownOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: none;
      pointer-events: none;
      color: #f7fdfa;
      font-size: clamp(7rem, 20vw, 16rem);
      font-weight: 800;
      z-index: 999;
      letter-spacing: 0.12em;
      mix-blend-mode: screen;
      text-shadow:
        0 0 1.5rem rgba(69, 162, 158, 0.8),
        0 0 3.5rem rgba(69, 162, 158, 0.6),
        0 0 5.5rem rgba(255, 198, 109, 0.8);
      animation: countdownGlow 1.2s ease-in-out infinite;
    }

    #countdownOverlay::after {
      inset: 18%;
      border: 0.2rem dashed rgba(255, 255, 255, 0.4);
      animation: countdownRing 1.2s linear infinite;
    }

    #countdownOverlay[data-visible="true"] {
      display: flex;
    }

    #countdownOverlay[data-visible="true"]::before {
      opacity: 1;
      transform: scale(1.05);
    }

    #countdownOverlay.flash {
      animation: countdownImpact 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes countdownGlow {
      0% {
        transform: scale(0.95);
        filter: drop-shadow(0 0 2rem rgba(69, 162, 158, 0.2));
        opacity: 0.85;
      }

      50% {
        transform: scale(1.05);
        filter: drop-shadow(0 0 4.5rem rgba(255, 198, 109, 0.6));
        opacity: 1;
      }

      100% {
        transform: scale(0.95);
        filter: drop-shadow(0 0 2rem rgba(69, 162, 158, 0.2));
        opacity: 0.85;
      }
    }

    @keyframes countdownImpact {
      0% {
        transform: scale(0.6) rotate(-8deg);
        opacity: 0.1;
      }

      40% {
        transform: scale(1.18) rotate(3deg);
        opacity: 1;
      }

      70% {
        transform: scale(0.92) rotate(-2deg);
      }

      100% {
        transform: scale(1) rotate(0);
        opacity: 1;
      }
    }

    @keyframes countdownRing {
      0% {
        transform: scale(0.7) rotate(0deg);
        opacity: 0.25;
      }

      50% {
        opacity: 0.6;
      }

      100% {
        transform: scale(1.1) rotate(360deg);
        opacity: 0.1;
      }
    }
  </style>
</head>

<body>
  <main>
    <video id="preview" autoplay playsinline muted></video>
    <img id="capturePreview" alt="Captured photo" hidden />
    <p class="status" id="status">Tap the button below to grant camera access.</p>
    <div class="actions">
      <button id="start">üé• Enable Camera</button>
      <button id="capture" disabled hidden>üì∏ Capture Photo</button>
      <button id="share" disabled hidden>üì§ Share Photo</button>
      <button id="cancel" hidden>‚Ü©Ô∏è Retake Photo</button>
      <a id="download" class="link-button" hidden aria-disabled="true">üíæ Download Photo</a>
      <button id="setCounter">üí© Ich hab's verkackt!</button>
    </div>
  </main>
  <div id="countdownOverlay" aria-live="assertive" aria-hidden="true"></div>

  <script>
    const startButton = document.getElementById('start');
    const status = document.getElementById('status');
    const preview = document.getElementById('preview');
    const capturePreview = document.getElementById('capturePreview');
    const captureButton = document.getElementById('capture');
    const shareButton = document.getElementById('share');
    const cancelButton = document.getElementById('cancel');
    const downloadLink = document.getElementById('download');
    const setCounterButton = document.getElementById('setCounter');
    const countdownOverlay = document.getElementById('countdownOverlay');

    let lastCaptureBlob = null;
    let lastCaptureFile = null;
    let lastCaptureFileName = '';
    let lastCaptureURL = null;
    const captureCanvas = document.createElement('canvas');
    let countdownInterval = null;

    const PROST_COOKIE = 'prostCounter';
    const PHOTO_DELAY = 3; // seconds
    const COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1 year.

    function readProstCounter() {
      const cookies = document.cookie ? document.cookie.split('; ') : [];
      for (const entry of cookies) {
        const [name, value] = entry.split('=');
        if (name === PROST_COOKIE) {
          const numeric = Number.parseInt(value, 10);
          if (Number.isFinite(numeric) && numeric > 0) {
            return numeric;
          }
        }
      }
      return null;
    }

    function writeProstCounter(value) {
      const safeValue = Math.max(0, Math.floor(value));
      document.cookie = `${PROST_COOKIE}=${safeValue}; max-age=${COOKIE_MAX_AGE}; path=/; SameSite=Lax`;
      return safeValue;
    }

    let prostCounter = readProstCounter();
    if (!Number.isFinite(prostCounter) || prostCounter === null || prostCounter < 0) {
      prostCounter = writeProstCounter(0);
    }

    function bumpProstCounter() {
      prostCounter = writeProstCounter(prostCounter + 1);
      return prostCounter;
    }

    function setProstCounterManually() {
      const input = window.prompt('How many Ma√ü did you already drink this Oktoberfest?', String(prostCounter));
      if (input === null) {
        return;
      }

      const nextValue = Number.parseInt(input.trim(), 10);
      if (!Number.isFinite(nextValue) || nextValue < 0) {
        window.alert('Please enter a whole number greater than or equal to 0.');
        return;
      }

      prostCounter = writeProstCounter(nextValue);
      status.textContent = `Counter updated. Next capture will be Prost #${prostCounter + 1}.`;
      resetCaptureState();
    }

    const hasNavigatorShare = typeof navigator.share === 'function';
    const supportsShareFiles = hasNavigatorShare
      && typeof navigator.canShare === 'function'
      && typeof File === 'function';

    if (!hasNavigatorShare) {
      shareButton.disabled = true;
      shareButton.hidden = true;
      shareButton.title = 'Sharing images requires a compatible browser.';
    } else if (!supportsShareFiles) {
      shareButton.title = 'Your browser may limit photo sharing; we will still try.';
    }

    async function enableCamera() {
      startButton.disabled = true;
      status.textContent = 'Requesting camera access...';

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'user' } },
          audio: false,
        });

        preview.srcObject = stream;
        preview.addEventListener('loadeddata', onPreviewReady, { once: true });
        status.textContent = 'Camera stream active.';
        startButton.textContent = '‚úÖ Camera Enabled';
      } catch (error) {
        console.error('getUserMedia failed', error);
        status.textContent = 'Unable to access the camera. Please check browser permissions and try again.';
        startButton.disabled = false;
      }
    }

    function onPreviewReady() {
      captureButton.disabled = false;
      captureButton.hidden = false;
      captureButton.style.display = 'inline-block';
      status.textContent = 'Camera ready. Capture a photo when you like.';
    }

    function resetCaptureState() {
      lastCaptureBlob = null;
      lastCaptureFile = null;
      lastCaptureFileName = '';
      if (lastCaptureURL) {
        URL.revokeObjectURL(lastCaptureURL);
        lastCaptureURL = null;
      }
      shareButton.disabled = true;
      shareButton.hidden = true;
      cancelButton.hidden = true;
      cancelButton.style.display = 'none';
      downloadLink.hidden = true;
      downloadLink.setAttribute('aria-disabled', 'true');
      capturePreview.hidden = true;
      capturePreview.removeAttribute('src');
      preview.hidden = false;
      stopCountdown();
    }

    function showCountdown(seconds) {
      if (seconds <= 0) {
        countdownOverlay.removeAttribute('data-visible');
        countdownOverlay.textContent = '';
        countdownOverlay.setAttribute('aria-hidden', 'true');
        countdownOverlay.classList.remove('flash');
        return;
      }

      countdownOverlay.textContent = seconds;
      countdownOverlay.setAttribute('data-visible', 'true');
      countdownOverlay.setAttribute('aria-hidden', 'false');
      countdownOverlay.classList.remove('flash');
      // Trigger reflow to restart animation.
      void countdownOverlay.offsetWidth;
      countdownOverlay.classList.add('flash');
    }

    function stopCountdown() {
      if (countdownInterval) {
        window.clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdownOverlay.removeAttribute('data-visible');
      countdownOverlay.textContent = '';
      countdownOverlay.setAttribute('aria-hidden', 'true');
      countdownOverlay.classList.remove('flash');
    }

    async function captureFrame() {
      if (!preview.srcObject) {
        status.textContent = 'Camera is not active.';
        return;
      }

      if (preview.readyState < HTMLMediaElement.HAVE_CURRENT_DATA) {
        status.textContent = 'Hold on‚Äîvideo is still loading.';
        return;
      }

      captureButton.disabled = true;
      captureButton.hidden = true;
      captureButton.style.display = 'none';
      status.textContent = 'Capturing photo...';

      resetCaptureState();

      const delaySeconds = Math.max(0, PHOTO_DELAY | 0);
      if (delaySeconds > 0) {
        let remaining = delaySeconds;
        showCountdown(remaining);
        countdownInterval = window.setInterval(() => {
          remaining -= 1;
          if (remaining <= 0) {
            stopCountdown();
            window.clearInterval(countdownInterval);
            countdownInterval = null;
          }
          showCountdown(Math.max(remaining, 0));
        }, 1000);

        await new Promise((resolve) => window.setTimeout(resolve, delaySeconds * 1000));
      }

      stopCountdown();

      const width = preview.videoWidth;
      const height = preview.videoHeight;

      if (!width || !height) {
        status.textContent = 'Unable to capture right now. Please try again.';
        captureButton.disabled = false;
        captureButton.hidden = false;
        captureButton.style.display = 'inline-block';
        return;
      }

      captureCanvas.width = width;
      captureCanvas.height = height;

      const ctx = captureCanvas.getContext('2d');
      if (!ctx) {
        status.textContent = 'Unable to capture right now. Please try again.';
        captureButton.disabled = false;
        captureButton.hidden = false;
        captureButton.style.display = 'inline-block';
        return;
      }
      ctx.save();
      ctx.translate(width, 0);
      ctx.scale(-1, 1); // Mirror to match on-screen preview.
      ctx.drawImage(preview, 0, 0, width, height);
      ctx.restore();

      const overlayNumber = prostCounter + 1;
      const overlayText = `Prost #${overlayNumber}`;
      const fontSize = Math.round(Math.min(width, height) * 0.08);
      const margin = Math.max(fontSize * 0.3, 16);
      const textX = width / 2;
      const textY = height - margin;

      ctx.font = `700 ${fontSize}px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.lineJoin = 'round';
      ctx.lineWidth = Math.max(fontSize * 0.12, 4);
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.85)';
      ctx.fillStyle = '#ffffff';
      ctx.strokeText(overlayText, textX, textY);
      ctx.fillText(overlayText, textX, textY);

      captureCanvas.toBlob((blob) => {
        captureButton.disabled = false;

        if (!blob) {
          status.textContent = 'Capture failed. Please try again.';
          captureButton.hidden = false;
          captureButton.style.display = 'inline-block';
          return;
        }

        lastCaptureBlob = blob;
        lastCaptureFileName = `front-camera-${Date.now()}.jpg`;
        lastCaptureFile = new File([blob], lastCaptureFileName, { type: blob.type });
        lastCaptureURL = URL.createObjectURL(blob);
        capturePreview.src = lastCaptureURL;
        capturePreview.hidden = false;
        preview.hidden = true;
        downloadLink.href = lastCaptureURL;
        downloadLink.download = lastCaptureFileName;
        downloadLink.hidden = false;
        downloadLink.setAttribute('aria-disabled', 'false');

        cancelButton.hidden = false;
        cancelButton.style.display = 'inline-block';

        let shareState = 'unavailable';

        if (hasNavigatorShare) {
          let canSharePhoto = true;

          if (supportsShareFiles) {
            try {
              canSharePhoto = navigator.canShare({ files: [lastCaptureFile] });
            } catch (error) {
              canSharePhoto = false;
            }
          }

          shareButton.disabled = false;
          shareButton.hidden = false;
          shareButton.title = canSharePhoto
            ? 'Share via apps like Signal or WhatsApp.'
            : 'Your browser might not support photo sharing, but you can try.';
          shareState = canSharePhoto ? 'available' : 'limited';
        } else {
          shareButton.disabled = true;
          shareButton.hidden = true;
        }

        status.textContent = shareState === 'available'
          ? 'Photo ready. Share, download, or retake below.'
          : shareState === 'limited'
            ? 'Photo ready. Sharing might not work in this browser‚Äîdownload or try sharing below.'
            : 'Photo ready. Share is unavailable on this device‚Äîdownload or retake below.';
      }, 'image/jpeg', 0.95);
    }

    async function shareCapture() {
      if (!lastCaptureBlob) {
        status.textContent = 'Capture a photo before sharing.';
        return;
      }

      if (!hasNavigatorShare || !lastCaptureFile) {
        status.textContent = 'Sharing is not supported on this device. Use the download option instead.';
        shareButton.disabled = true;
        shareButton.hidden = true;
        return;
      }

      if (supportsShareFiles) {
        let canSharePhoto = false;

        try {
          canSharePhoto = navigator.canShare({ files: [lastCaptureFile] });
        } catch (error) {
          canSharePhoto = false;
        }

        if (!canSharePhoto) {
          status.textContent = 'This browser cannot share photos. Use the download option instead.';
          shareButton.title = 'Download the photo, then share it manually.';
          return;
        }
      }

      const sharePayload = { files: [lastCaptureFile], title: 'Front camera photo' };

      try {
        await navigator.share(sharePayload);
        const updatedCounter = bumpProstCounter();
        status.textContent = `Shared! Next photo will be Prost #${updatedCounter + 1}.`;
      } catch (error) {
        if (error.name === 'AbortError') {
          return;
        }

        console.error('Share failed', error);

        if (!supportsShareFiles && error.name === 'TypeError') {
          status.textContent = 'This browser does not support sharing photos. Use download instead.';
          shareButton.title = 'Download the photo, then share it manually.';
          return;
        }

        status.textContent = 'Sharing failed. You can still download the photo.';
      }
    }
    function cancelCapture() {
      resetCaptureState();
      captureButton.disabled = false;
      captureButton.hidden = false;
      captureButton.style.display = 'inline-block';
      status.textContent = 'Camera ready. Capture a photo when you like.';
    }

    resetCaptureState();

    if (!navigator.mediaDevices?.getUserMedia) {
      status.textContent = 'Camera access is not supported in this browser.';
      startButton.disabled = true;
      captureButton.disabled = true;
    } else {
      startButton.addEventListener('click', enableCamera);
      captureButton.addEventListener('click', captureFrame);
      shareButton.addEventListener('click', shareCapture);
      cancelButton.addEventListener('click', cancelCapture);
      setCounterButton.addEventListener('click', setProstCounterManually);

      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({ name: 'camera' }).then((result) => {
          if (result.state === 'granted') {
            enableCamera();
          }
        }).catch(() => { });
      }
    }
  </script>
</body>

</html>